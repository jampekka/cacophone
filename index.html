<script src="livescript.js"></script>
<a href="#" id="toggle">Start/Stop</a>
<script type="text/ls">

randomHarmonic = ({root=220}={}) ->
	#wl = 1.0/root
	#overtone = wl/Math.ceil(Math.random!**2*7)
	#return 1.0/overtone
	nTones = Math.ceil(Math.random!*6)
	cents = 100*nTones*2
	return root*2**(cents/1200)

randomHarmony = (n=10) ->
	ctx = new AudioContext!
	rndcoord = -> (Math.random()-0.5)*10
	for i from 0 til n
		oscillator = ctx.createOscillator!
		oscillator.type = "sine"
		oscillator.frequency.value = randomHarmonic!
		gain = ctx.createGain!
		gain.gain.value = 1/n
		oscillator.connect gain
		panner = ctx.createPanner()
		panner.setPosition rndcoord!, rndcoord!, 0
		gain.connect panner
		panner.connect ctx.destination
		oscillator.start()

	dt = 1/60
	x = 0
	v = 5
	move = ->
		return false if ctx.state == 'closed'
		if Math.abs(x) > 10
			v *= -1
		x += v*dt
		ctx.listener.setPosition x, 0, 0

	setInterval move, dt*1000

	return ctx

ctx = void
document.getElementById("toggle").onclick = ->
	if ctx?
		ctx.close()
		ctx := void
		return
	
	ctx := randomHarmony!

</script>

<script>
    var LiveScript = require("LiveScript");
    LiveScript.go();
</script>
